<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOFI CRM â€” Reviews</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="./reviewsData.js"></script>

  <style>
    main.app { padding-top: 1rem; }
    .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .integration-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
    .integration-card {
      text-align: center;
      background: var(--surface-subtle);
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid var(--card-border);
      transition: 0.25s;
    }
    .integration-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.05); }
    .integration-card img { width: 36px; height: 36px; margin-bottom: 0.5rem; }
    .status { display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin: 0.5rem 0; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; }
    .dot.green { background: #22c55e; }
    .dot.yellow { background: #facc15; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    .review-list { display: flex; flex-direction: column; gap: 0.8rem; }
    .review-card { border: 1px solid var(--card-border); border-radius: 10px; background: var(--surface-subtle); padding: 0.9rem 1.1rem; }
    .review-name { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .review-name span { color: var(--text-muted); font-weight: 400; font-size: 0.8rem; }
    .review-msg { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; }
    .review-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; gap: 4px; }
    .stars { color: #facc15; font-size: 0.8rem; }
    .green { color: #22c55e; }
    .red { color: #ef4444; }
    .small { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <span class="brand-mark">â—Ž</span>
      <div>
        <h1>KOFI CRM</h1>
        <p>Customer Reviews & Sentiment</p>
      </div>
    </div>
  </header>

  <main class="app">
    <!-- Integrations -->
    <section class="card">
      <div class="card-header">
        <h3>Platform Integrations</h3>
      </div>
      <p class="muted mb-4">Connect your Facebook and Google accounts to sync and analyze reviews automatically.</p>
      <div class="integration-grid">
        <div class="integration-card">
          <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook">
          <h4>Facebook Reviews</h4>
          <div class="status">
            <span id="fbStatus" class="dot red"></span>
            <small id="fbStatusText">Not Connected</small>
          </div>
          <button id="connectFb" class="primary small">Connect</button>
        </div>

        <div class="integration-card">
          <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="Google">
          <h4>Google Reviews</h4>
          <div class="status">
            <span id="googleStatus" class="dot red"></span>
            <small id="googleStatusText">Not Connected</small>
          </div>
          <button id="connectGoogle" class="danger small">Connect</button>
        </div>
      </div>

      <div class="center mt-4">
        <button id="resetBtn" class="secondary small">Reset Integrations</button>
      </div>
    </section>

    <!-- Overview -->
    <section class="card">
      <div class="card-header">
        <h3>Sentiment Overview</h3>
        <div class="stats">
          Total: <span id="totalCount">0</span> |
          ðŸ˜Š <span id="goodCount">0</span> |
          ðŸ˜ž <span id="badCount">0</span>
        </div>
      </div>
      <canvas id="reviewChart" height="120"></canvas>
    </section>

    <!-- Reviews -->
    <section class="grid-2">
      <div class="card">
        <div class="card-header between">
          <h3 class="green">Positive Reviews</h3>
          <button id="exportGood" class="secondary small">â¬‡ Export</button>
        </div>
        <div id="goodReviews" class="review-list"></div>
      </div>

      <div class="card">
        <div class="card-header between">
          <h3 class="red">Negative Reviews</h3>
          <button id="exportBad" class="secondary small">â¬‡ Export</button>
        </div>
        <div id="badReviews" class="review-list"></div>
      </div>
    </section>
  </main>

  <footer class="app-footer"><p>Â© 2025 KOFI CRM â€” Reviews Module</p></footer>

  <!-- Supabase (shared) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/config/supabase.js"></script>
  <script src="/scripts/auth.js"></script>

  <!-- Shared Sidebar -->
  <script src="/components/sidebar.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const session = await requireAuth();
      if (!session) return;
      loadSidebar("reviews");
    });
  </script>

  <script>
    // ===== Review integration logic =====
    let fbConnected = false, googleConnected = false;
    const fbStatus = document.getElementById('fbStatus');
    const fbText = document.getElementById('fbStatusText');
    const googleStatus = document.getElementById('googleStatus');
    const googleText = document.getElementById('googleStatusText');

    function updateStatus(el, textEl, status) {
      el.classList.remove('green','yellow','red');
      if (status==='connecting'){ el.classList.add('yellow'); textEl.textContent='Connecting...'; }
      if (status==='connected'){ el.classList.add('green'); textEl.textContent='Connected'; }
      if (status==='reset'){ el.classList.add('red'); textEl.textContent='Not Connected'; }
    }

    document.getElementById('connectFb').onclick = ()=>{
      updateStatus(fbStatus,fbText,'connecting');
      setTimeout(()=>{fbConnected=true;updateStatus(fbStatus,fbText,'connected');loadReviews();},800);
    };
    document.getElementById('connectGoogle').onclick = ()=>{
      updateStatus(googleStatus,googleText,'connecting');
      setTimeout(()=>{googleConnected=true;updateStatus(googleStatus,googleText,'connected');loadReviews();},800);
    };
    document.getElementById('resetBtn').onclick = ()=>{
      fbConnected=googleConnected=false;
      updateStatus(fbStatus,fbText,'reset');
      updateStatus(googleStatus,googleText,'reset');
      loadReviews(true);
    };

    // ===== Chart + Reviews =====
    let chart;
    function updateChart(good,bad){
      const ctx=document.getElementById("reviewChart").getContext("2d");
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:"bar",
        data:{labels:["Positive","Negative"],datasets:[{data:[good,bad],backgroundColor:["#22c55e","#ef4444"]}]},
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }

    function loadReviews(reset=false){
      const goodList=document.getElementById('goodReviews');
      const badList=document.getElementById('badReviews');
      if(reset||(!fbConnected&&!googleConnected)){goodList.innerHTML=badList.innerHTML='';updateChart(0,0);return;}
      goodList.innerHTML=badList.innerHTML='';
      let good=0,bad=0;
      demoReviews.forEach(r=>{
        if((r.platform==='Google'&&googleConnected)||(r.platform==='Facebook'&&fbConnected)){
          const stars='â˜…'.repeat(r.rating)+'â˜†'.repeat(5-r.rating);
          const html=`<div class="review-card">
            <p class="review-name">${r.name} <span>(${r.platform})</span></p>
            <p class="review-msg">${r.message}</p>
            <div class="review-meta"><span class="stars">${stars}</span> | ${r.date}</div>
          </div>`;
          if(r.sentiment==='positive'){good++;goodList.innerHTML+=html;} else {bad++;badList.innerHTML+=html;}
        }
      });
      document.getElementById("totalCount").textContent=good+bad;
      document.getElementById("goodCount").textContent=good;
      document.getElementById("badCount").textContent=bad;
      updateChart(good,bad);
    }

    function exportCSV(type){
      const active=demoReviews.filter(r=>r.sentiment===type&&((r.platform==='Google'&&googleConnected)||(r.platform==='Facebook'&&fbConnected)));
      const csv="Name,Platform,Rating,Message,Date\n"+active.map(r=>`"${r.name}","${r.platform}",${r.rating},"${r.message}","${r.date}"`).join("\n");
      const blob=new Blob([csv],{type:"text/csv"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download=`${type}_reviews.csv`;
      link.click();
    }
    document.getElementById('exportGood').onclick=()=>exportCSV('positive');
    document.getElementById('exportBad').onclick=()=>exportCSV('negative');
  </script>
</body>
</html>
