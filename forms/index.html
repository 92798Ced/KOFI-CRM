<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOFI CRM ‚Äî Forms & Calendar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header class="app-header">
  <div class="brand">
    <span class="brand-mark">‚óé</span>
    <div>
      <h1>Forms & Calendar</h1>
      <p>Manage forms, folders, and booking calendars.</p>
    </div>
  </div>
  <div class="header-right">
    <button id="addFolderBtn" class="secondary">üìÅ New Folder</button>
    <button id="addFormBtn" class="primary">‚ûï New Form</button>
  </div>
</header>

<main class="app forms-page">
  <div class="tab-bar">
    <button class="tab active" data-tab="formsTab">Forms</button>
    <button class="tab" data-tab="calendarTab">Calendars</button>
  </div>

  <!-- FORMS -->
  <section id="formsTab" class="tab-content active">
    <div id="formsBoard" class="forms-board"></div>
  </section>

  <!-- CALENDARS -->
  <section id="calendarTab" class="tab-content hidden">
    <div class="calendar-header">
      <div>
        <h2>Booking Calendars</h2>
        <p class="muted">Manage your schedulers, customize appearance, and link forms or thank-you pages.</p>
      </div>
      <button id="addCalendarBtn" class="primary">‚ûï New Calendar</button>
    </div>
    <div id="calendarBoard" class="forms-board"></div>
  </section>
</main>

<footer class="app-footer"><p>¬© 2025 KOFI CRM ‚Äî Forms Module</p></footer>

<!-- Modals -->
<div id="formModal" class="modal hidden">
  <div class="modal-content form-card">
    <div class="modal-header"><h2>New Form</h2><button class="close-modal" id="closeFormModal">√ó</button></div>
    <form id="formForm" class="modal-body">
      <label>Form Name *</label><input type="text" id="form_name" required>
      <label>Folder</label><select id="form_folder"></select>
      <label>Status</label><select id="form_status"><option>Active</option><option>Draft</option></select>
      <div class="modal-actions">
        <button type="button" class="secondary" id="cancelFormModal">Cancel</button>
        <button type="submit" class="primary">Create & Open Editor</button>
      </div>
    </form>
  </div>
</div>

<div id="folderModal" class="modal hidden">
  <div class="modal-content form-card">
    <div class="modal-header"><h2>New Folder</h2><button class="close-modal" id="closeFolderModal">√ó</button></div>
    <form id="folderForm" class="modal-body">
      <label>Folder Name *</label><input type="text" id="folder_name" required>
      <label>Folder Color</label><input type="color" id="folder_color" value="#8b5cf6">
      <div class="modal-actions">
        <button type="button" class="secondary" id="cancelFolderModal">Cancel</button>
        <button type="submit" class="primary">Create Folder</button>
      </div>
    </form>
  </div>
</div>

<script src="/components/sidebar.js"></script>
<script>
const SUPABASE_URL = "https://usopxhshfmmtnnvkzelj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzb3B4aHNoZm1tdG5udmt6ZWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTc2MzIsImV4cCI6MjA3NjM5MzYzMn0.3qG3t-QTc6UsRt74GXjL_pBVfibG42X5wGyWRLYu3NE";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

document.addEventListener("DOMContentLoaded", async () => {
  loadSidebar("forms");

  const formsBoard = document.getElementById("formsBoard");
  const addFolderBtn = document.getElementById("addFolderBtn");
  const addFormBtn = document.getElementById("addFormBtn");
  const folderModal = document.getElementById("folderModal");
  const formModal = document.getElementById("formModal");
  const folderForm = document.getElementById("folderForm");
  const formForm = document.getElementById("formForm");

  /* ---------------- LOAD FORMS & FOLDERS ---------------- */
  async function loadFolders() {
    const { data: folders, error: folderErr } = await supabase.from("folders").select("*").order("updated_at", { ascending: false });
    const { data: forms, error: formErr } = await supabase.from("forms").select("*").order("updated_at", { ascending: false });

    if (folderErr) console.error("folders error:", folderErr);
    if (formErr) console.error("forms error:", formErr);

    formsBoard.innerHTML = "";

    if ((!folders || !folders.length) && (!forms || !forms.length)) {
      formsBoard.innerHTML = "<p class='muted'>No forms yet.</p>";
      return;
    }

    (folders || []).forEach((folder) => {
      const div = document.createElement("div");
      div.className = "forms-folder";
      div.innerHTML = `
        <div class="folder-header" style="border-left:5px solid ${folder.color || '#6366f1'}">
          <h3>${folder.name}</h3>
          <div class="folder-actions">
            <button class="secondary small toggleFolder">‚ñº</button>
            <button class="secondary small editFolder">‚úèÔ∏è</button>
            <button class="secondary small danger delFolder">üóë</button>
          </div>
        </div>
        <div class="forms-list"></div>
      `;
      const list = div.querySelector(".forms-list");
      (forms || []).filter(f => f.folder_id === folder.id).forEach((form) => {
        const card = document.createElement("div");
        card.className = "form-card";
        card.innerHTML = `
          <div class="card-main">
            <h4>${form.title || form.name}</h4>
            <p class="muted">${form.description || "No description"}</p>
          </div>
          <div class="card-meta">
            <button class="secondary small editForm">‚úèÔ∏è</button>
            <button class="secondary small danger delForm">üóë</button>
          </div>`;
        card.querySelector(".editForm").onclick = (e) => {
          e.stopPropagation();
          const newName = prompt("Rename form:", form.title || form.name);
          if (!newName) return;
          supabase.from("forms").update({ title: newName, name: newName }).eq("id", form.id).then(loadFolders);
        };
        card.querySelector(".delForm").onclick = (e) => {
          e.stopPropagation();
          if (confirm("Delete form?")) supabase.from("forms").delete().eq("id", form.id).then(loadFolders);
        };
        card.onclick = () => window.open(`/forms/builder.html?id=${form.id}`, "_blank");
        list.appendChild(card);
      });

      div.querySelector(".toggleFolder").onclick = (e) => {
        list.classList.toggle("hidden");
        e.target.textContent = list.classList.contains("hidden") ? "‚ñ∫" : "‚ñº";
      };
      div.querySelector(".editFolder").onclick = async () => {
        const newName = prompt("Rename folder:", folder.name);
        if (newName) await supabase.from("folders").update({ name: newName }).eq("id", folder.id);
        loadFolders();
      };
      div.querySelector(".delFolder").onclick = async () => {
        if (confirm("Delete folder?")) await supabase.from("folders").delete().eq("id", folder.id);
        loadFolders();
      };
      formsBoard.appendChild(div);
    });

    const ungrouped = (forms || []).filter(f => !f.folder_id);
    if (ungrouped.length) {
      const div = document.createElement("div");
      div.className = "forms-folder";
      div.innerHTML = `<div class="folder-header" style="border-left:5px solid #9ca3af"><h3>Uncategorized</h3></div>`;
      const list = document.createElement("div");
      list.className = "forms-list";
      ungrouped.forEach((form) => {
        const card = document.createElement("div");
        card.className = "form-card";
        card.innerHTML = `<div class="card-main"><h4>${form.title || form.name}</h4></div>`;
        card.onclick = () => window.open(`/forms/builder.html?id=${form.id}`, "_blank");
        list.appendChild(card);
      });
      div.appendChild(list);
      formsBoard.appendChild(div);
    }

    const folderSelect = document.getElementById("form_folder");
    folderSelect.innerHTML = `<option value="">Select Folder</option>`;
    (folders || []).forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      folderSelect.appendChild(opt);
    });
  }

  await loadFolders();

  /* ---------------- CALENDARS ---------------- */
  async function loadCalendars() {
    const { data: calendars, error } = await supabase.from("crm_events").select("*").order("created_at", { ascending: false });
    const board = document.getElementById("calendarBoard");
    board.innerHTML = "";

    if (error) {
      console.error(error);
      board.innerHTML = `<p class='muted'>Error loading calendars.</p>`;
      return;
    }
    if (!calendars?.length) {
      board.innerHTML = `<p class='muted'>No calendars yet.</p>`;
      return;
    }

    calendars.forEach(cal => {
      const card = document.createElement("div");
      card.className = "form-card";
      card.innerHTML = `
        <div class="card-main">
          <img src="${cal.image_url || '/assets/default-calendar.jpg'}" class="calendar-thumb">
          <div>
            <h4>${cal.title || "Untitled Calendar"}</h4>
            <p class="muted">${cal.description || "No description provided"}</p>
          </div>
        </div>
        <div class="card-meta">
          <button class="secondary small editCal">‚úèÔ∏è</button>
          <button class="secondary small danger delCal">üóë</button>
        </div>`;
      card.querySelector(".editCal").onclick = (e) => {
        e.stopPropagation();
        window.open(`/forms/calendar_editor.html?id=${cal.id}`, "_blank");
      };
      card.querySelector(".delCal").onclick = async (e) => {
        e.stopPropagation();
        if (confirm("Delete this calendar?")) {
          await supabase.from("crm_events").delete().eq("id", cal.id);
          loadCalendars();
        }
      };
      card.onclick = () => window.open(`/forms/calendar_editor.html?id=${cal.id}`, "_blank");
      board.appendChild(card);
    });
  }

  document.getElementById("addCalendarBtn").onclick = async () => {
    const title = prompt("Enter calendar title:");
    if (!title) return;
const today = new Date().toISOString().split("T")[0]; // example: 2025-10-20
const { data, error } = await supabase
  .from("crm_events")
  .insert([{ title, date: today }]) // ‚úÖ add a default date
  .select()
  .single();

    if (error) return alert(error.message);
    window.open(`/calendar_editor.html?id=${data.id}`, "_blank");
    loadCalendars();
  };

  /* ---------------- TAB SWITCHING ---------------- */
  document.querySelectorAll(".tab").forEach(tabBtn => {
    tabBtn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
      tabBtn.classList.add("active");
      const target = document.getElementById(tabBtn.dataset.tab);
      if (target) target.classList.remove("hidden");
      if (tabBtn.dataset.tab === "calendarTab") loadCalendars();
    });
  });

  /* ---------------- MODALS ---------------- */
  addFolderBtn.onclick = () => folderModal.classList.remove("hidden");
  addFormBtn.onclick = () => formModal.classList.remove("hidden");
  ["closeFolderModal", "cancelFolderModal"].forEach(id => document.getElementById(id).onclick = () => folderModal.classList.add("hidden"));
  ["closeFormModal", "cancelFormModal"].forEach(id => document.getElementById(id).onclick = () => formModal.classList.add("hidden"));

  folderForm.onsubmit = async (e) => {
    e.preventDefault();
    const name = document.getElementById("folder_name").value.trim();
    const color = document.getElementById("folder_color").value;
    if (!name) return alert("Please enter a folder name");
    await supabase.from("folders").insert([{ name, color }]);
    folderForm.reset();
    folderModal.classList.add("hidden");
    loadFolders();
  };

formForm.onsubmit = async (e) => {
  e.preventDefault();

  const name = document.getElementById("form_name").value.trim();
  const folder_id_raw = document.getElementById("form_folder").value;
  const folder_id = folder_id_raw ? folder_id_raw : null;
  const status = document.getElementById("form_status").value.toLowerCase();

  if (!name) return alert("Please enter a form name");

  const { data, error } = await supabase
    .from("forms")
    .insert([
      {
        title: name,
        folder_id,
        status,
        schema: { fields: [], fontSettings: { fontFamily: "Poppins", fontSize: 16, lineHeight: 1.5 } },
      },
    ])
    .select()
    .single();

  if (error) {
    console.error(error);
    alert("Error creating form: " + error.message);
    return;
  }

  formForm.reset();
  formModal.classList.add("hidden");
  loadFolders();

  if (data?.id) window.open(`/forms/builder.html?id=${data.id}`, "_blank");
};
});
</script>

<style>
.tab-bar{display:flex;gap:10px;margin:1rem 0;}
.tab{padding:.5rem 1rem;border:none;border-radius:6px;background:var(--surface-subtle);cursor:pointer;}
.tab.active{background:var(--primary);color:white;}
.tab-content.hidden{display:none;}
.forms-board{display:flex;flex-direction:column;gap:20px;margin-top:1rem;}
.folder-header{display:flex;justify-content:space-between;align-items:center;background:var(--surface);padding:10px;border-radius:8px;}
.forms-folder{background:var(--surface-subtle);padding:1rem;border-radius:10px;}
.form-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.form-card:hover{transform:scale(1.02);transition:.1s;}
.calendar-thumb{width:70px;height:70px;object-fit:cover;border-radius:8px;margin-right:1rem;}
.card-main{display:flex;align-items:center;gap:1rem;}
.calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
.modal-content.form-card{display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;width:100%;max-width:420px;padding:1.5rem;border-radius:14px;box-sizing:border-box;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
.modal-body{display:flex;flex-direction:column;gap:0.75rem;}
.modal-actions{display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.25rem;}
</style>
</body>
</html>
