<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loom CRM ‚Äî Automations</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <span class="brand-mark">‚óé</span>
      <div>
        <h1>Automations</h1>
        <p>Trigger workflows, follow-ups, and system actions automatically.</p>
      </div>
    </div>
    <div class="header-right">
      <button id="addFolderBtn" class="secondary">üìÅ New Folder</button>
      <button id="addAutomationBtn" class="primary">‚ûï New Automation</button>
    </div>
  </header>

  <main class="app forms-page">
    <section class="dashboard">
      <div class="forms-header">
        <div>
          <h1>Automation Center</h1>
          <p class="muted">Visualize and manage automated workflows across your CRM.</p>
        </div>
      </div>

      <div id="automationBoard" class="automation-board"></div>
    </section>
  </main>

  <footer class="app-footer">
    <p>¬© 2025 Loom & Prints ‚Äî Automations Module</p>
  </footer>

  <!-- Add Automation Modal -->
  <div id="automationModal" class="modal hidden">
    <div class="modal-content form-card">
      <div class="modal-header">
        <h2>New Automation</h2>
        <button class="close-modal" id="closeAutomationModal">√ó</button>
      </div>

      <form id="automationForm" class="modal-body">
        <label>Automation Name *</label>
        <input type="text" id="automation_name" required />

        <label>Folder</label>
        <select id="automation_folder"></select>

        <label>Status</label>
        <select id="automation_status">
          <option>Active</option>
          <option>Paused</option>
        </select>

        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelAutomationModal">Cancel</button>
          <button type="submit" class="primary">Create & Open Editor</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Folder Modal -->
  <div id="folderModal" class="modal hidden">
    <div class="modal-content form-card">
      <div class="modal-header">
        <h2>New Folder</h2>
        <button class="close-modal" id="closeFolderModal">√ó</button>
      </div>

      <form id="folderForm" class="modal-body">
        <label>Folder Name *</label>
        <input type="text" id="folder_name" required />

        <label>Folder Color</label>
        <input type="color" id="folder_color" value="#6366f1" />

        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelFolderModal">Cancel</button>
          <button type="submit" class="primary">Create Folder</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/components/sidebar.js"></script>
  <script>
    const SUPABASE_URL = "https://usopxhshfmmtnnvkzelj.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzb3B4aHNoZm1tdG5udmt6ZWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTc2MzIsImV4cCI6MjA3NjM5MzYzMn0.3qG3t-QTc6UsRt74GXjL_pBVfibG42X5wGyWRLYu3NE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    document.addEventListener("DOMContentLoaded", async () => {
      loadSidebar("automations");

      const addFolderBtn = document.getElementById("addFolderBtn");
      const addAutomationBtn = document.getElementById("addAutomationBtn");
      const folderModal = document.getElementById("folderModal");
      const automationModal = document.getElementById("automationModal");
      const folderForm = document.getElementById("folderForm");
      const automationForm = document.getElementById("automationForm");
      const board = document.getElementById("automationBoard");

      async function loadFolders() {
        const { data: folders } = await supabase
          .from("automation_folders")
          .select("*")
          .order("position");

        const { data: automations } = await supabase
          .from("automations")
          .select("*")
          .order("created_at", { ascending: true });

        board.innerHTML = "";
        (folders || []).forEach((folder) => {
          const div = document.createElement("div");
          div.className = "automation-folder";
          div.innerHTML = `
            <div class="folder-header" style="border-left:5px solid ${folder.color}">
              <h3>${folder.name}</h3>
              <div class="folder-actions">
                <button class="secondary small toggleFolder">‚ñº</button>
                <button class="secondary small">‚úèÔ∏è</button>
                <button class="secondary small danger">üóë</button>
              </div>
            </div>
            <div class="automation-list"></div>
          `;

          const list = div.querySelector(".automation-list");
          (automations || [])
            .filter((a) => a.folder_id === folder.id)
            .forEach((auto) => {
              const card = document.createElement("div");
              card.className = "automation-card";
              card.innerHTML = `
                <div class="card-main">
                  <h4>${auto.name}</h4>
                  <p class="muted">${
  auto.trigger && auto.trigger !== "[]"
    ? (Array.isArray(auto.trigger)
        ? auto.trigger[0]?.label
        : (JSON.parse(auto.trigger || "[]")[0]?.label || "Workflow ready"))
    : "No workflow created yet"
}</p>

                </div>
                <div class="card-meta">
                  <span class="badge">${auto.status || "Active"}</span>
                </div>`;
              list.appendChild(card);
            });

          div.querySelector(".toggleFolder").addEventListener("click", (e) => {
            list.classList.toggle("hidden");
            e.target.textContent = list.classList.contains("hidden") ? "‚ñ∫" : "‚ñº";
          });

          board.appendChild(div);
        });

        // refresh folder dropdown
        const folderSelect = document.getElementById("automation_folder");
        folderSelect.innerHTML = `<option value="">Select Folder</option>`;
        (folders || []).forEach((f) => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.name;
          folderSelect.appendChild(opt);
        });
      }

      await loadFolders();

      // modal open/close
      addFolderBtn.addEventListener("click", () =>
        folderModal.classList.remove("hidden")
      );
      addAutomationBtn.addEventListener("click", () =>
        automationModal.classList.remove("hidden")
      );

      ["closeFolderModal", "cancelFolderModal"].forEach((id) =>
        document.getElementById(id).addEventListener("click", () =>
          folderModal.classList.add("hidden")
        )
      );
      ["closeAutomationModal", "cancelAutomationModal"].forEach((id) =>
        document.getElementById(id).addEventListener("click", () =>
          automationModal.classList.add("hidden")
        )
      );

      // create folder
      folderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("folder_name").value.trim();
        const color = document.getElementById("folder_color").value;
        if (!name) return alert("Please enter a folder name.");
        await supabase.from("automation_folders").insert([{ name, color }]);
        folderForm.reset();
        folderModal.classList.add("hidden");
        await loadFolders();
      });

      // create automation (only name + folder + status, then open editor)
      automationForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("automation_name").value.trim();
        const folder_id =
          parseInt(document.getElementById("automation_folder").value) || null;
        const status = document.getElementById("automation_status").value;

        if (!name) return alert("Please enter an automation name.");

        const { data: inserted, error } = await supabase
          .from("automations")
          .insert([{ name, folder_id, status }])
          .select()
          .single();

        if (error) {
          alert("Error creating automation: " + error.message);
          return;
        }

        automationForm.reset();
        automationModal.classList.add("hidden");
        await loadFolders();

        if (inserted?.id) {
          window.open(`/automations/editor.html?id=${inserted.id}`, "_blank");
        }
      });
    });
  </script>

  <style>
    .automation-board {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 1rem;
    }
    .folder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface);
      padding: 10px;
      border-radius: 8px;
    }
    .automation-folder {
      background: var(--surface-subtle);
      padding: 1rem;
      border-radius: 10px;
    }
    .automation-list {
      margin-top: 10px;
    }
    .automation-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .automation-card:hover {
      transform: scale(1.02);
      transition: 0.1s;
    }
  </style>
</body>
</html>
